<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.stock.webpage.mapper.CompanyInfoKrMapper">

    <!-- =====================================================
         이름 포함 검색
         ===================================================== -->
    <select id="selectByNameContaining"
            resultType="com.stock.webpage.dto.CompanyInfoKrDTO">

        SELECT
            code,
            name,
            market_type   AS marketType,
            security_type AS securityType,
            stock_type    AS stockType,
            std_code      AS stdCode,
            last_update   AS lastUpdate
        FROM company_info_kr
        WHERE LOWER(name) LIKE CONCAT('%', LOWER(#{name}), '%')
        ORDER BY name
    </select>


    <!-- =====================================================
         자동완성 (이름 / 코드)
         ===================================================== -->
    <select id="selectTopByNameOrCodeContaining"
            resultType="com.stock.webpage.dto.CompanyInfoKrDTO">

        SELECT
            c.code,
            c.name,
            c.market_type   AS marketType,
            c.security_type AS securityType,
            c.stock_type    AS stockType,
            c.std_code      AS stdCode,
            c.last_update   AS lastUpdate,
            p.close   AS price
        FROM company_info_kr c
                 LEFT JOIN (
            SELECT
                code,
                close
            FROM daily_price_kr d
            WHERE d.date = (
                SELECT MAX(date)
                FROM daily_price_kr
                WHERE code = d.code
            )
        ) p ON c.code = p.code
        WHERE
            (
                LOWER(c.name) LIKE CONCAT('%', LOWER(#{keyword}), '%')
                    OR LOWER(c.code) LIKE CONCAT('%', LOWER(#{keyword}), '%')
                )
          AND c.stock_type = '보통주'
        ORDER BY
            CASE
                WHEN LOWER(c.code) = LOWER(#{keyword}) THEN 0
                WHEN LOWER(c.name) = LOWER(#{keyword}) THEN 1
                ELSE 2
                END,
            c.name
            LIMIT #{limit}

    </select>




    <!-- =====================================================
         코드 단건 조회
         ===================================================== -->
    <select id="selectByCode"
            resultType="CompanyInfoKrDto">
        SELECT
            code,
            name,
            market_type   AS marketType,
            security_type AS securityType,
            stock_type    AS stockType,
            std_code      AS stdCode,
            last_update   AS lastUpdate
        FROM company_info_kr
        WHERE code = #{code}
    </select>

</mapper>

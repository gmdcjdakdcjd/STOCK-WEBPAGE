<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.stock.webpage.mapper.CompanyInfoUsMapper">

    <!-- =====================================================
         이름 포함 검색
         ===================================================== -->
    <select id="selectByNameContaining"
            resultType="com.stock.webpage.dto.CompanyInfoUsDTO">

        SELECT
            code,
            name,
            sector,
            industry,
            market,
            cik,
            last_update AS lastUpdate
        FROM company_info_us
        WHERE LOWER(name) LIKE CONCAT('%', LOWER(#{name}), '%')
        ORDER BY name
    </select>

    <!-- =====================================================
         자동완성 (이름 / 코드)
         ===================================================== -->
    <select id="selectTopByNameOrCodeContaining"
            resultType="com.stock.webpage.dto.CompanyInfoUsDTO">

        SELECT
            c.code,
            c.name,
            c.sector,
            c.industry,
            c.market,
            c.cik,
            c.last_update AS lastUpdate,
            p.close       AS price
        FROM company_info_us c
                 LEFT JOIN (
            SELECT
                d.code,
                d.close
            FROM daily_price_us d
            WHERE d.date = (
                SELECT MAX(date)
                FROM daily_price_us
                WHERE code = d.code
            )
        ) p ON c.code = p.code
        WHERE
            LOWER(c.name) LIKE CONCAT('%', LOWER(#{keyword}), '%')
           OR LOWER(c.code) LIKE CONCAT('%', LOWER(#{keyword}), '%')
        ORDER BY
            CASE
                WHEN LOWER(c.code) = LOWER(#{keyword}) THEN 0
                WHEN LOWER(c.name) = LOWER(#{keyword}) THEN 1
                ELSE 2
                END,
            c.name
            LIMIT #{limit}

    </select>


    <!-- =====================================================
         코드 단건 조회 (상세 화면용)
         ===================================================== -->
    <select id="selectByCode"
            resultType="com.stock.webpage.dto.CompanyInfoUsDTO">

        SELECT
            code,
            name,
            sector,
            industry,
            market,
            cik,
            last_update AS lastUpdate
        FROM company_info_us
        WHERE code = #{code}
    </select>

</mapper>

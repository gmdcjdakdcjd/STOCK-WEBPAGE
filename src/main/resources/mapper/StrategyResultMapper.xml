<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.stock.webpage.mapper.StrategyResultMapper">

    <!-- =====================================================
         existsByStrategyNameAndSignalDate
         ===================================================== -->
    <select id="existsByStrategyNameAndSignalDate" resultType="boolean">
        SELECT EXISTS (
            SELECT 1
            FROM strategy_result
            WHERE strategy_name = #{strategyName}
        <![CDATA[
              AND signal_date >= #{signalDate}
              AND signal_date < DATE_ADD(#{signalDate}, INTERVAL 1 DAY)
        ]]>
    )
    </select>


    <!-- =====================================================
         findTopByStrategyNameOrderBySignalDateDesc
         ===================================================== -->
    <select id="selectLatestByStrategyName" resultType="StrategyResultDto">
        SELECT
            strategy_name AS strategyName,
            signal_date   AS signalDate,
            signal_type   AS signalType,
            total_data    AS totalData,
            created_at    AS createdAt
        FROM strategy_result
        WHERE strategy_name = #{strategyName}
        ORDER BY signal_date DESC
            LIMIT 1
    </select>

    <!-- suffix 조건 제거 -->
    <select id="selectStrategyResults" resultType="StrategyResultDto">
        SELECT
        strategy_name AS strategyName,
        signal_date   AS signalDate,
        signal_type   AS signalType,
        total_data    AS totalData,
        created_at    AS createdAt
        FROM strategy_result
        WHERE 1 = 1

        <if test="strategies != null and strategies.size() > 0">
            AND strategy_name IN
            <foreach collection="strategies" item="s" open="(" separator="," close=")">
                #{s}
            </foreach>
        </if>

        <!-- 단일 전략 필터 -->
        <if test="strategy != null and strategy != ''">
            AND strategy_name = #{strategy}
        </if>

        <if test="signalDate != null">
            <![CDATA[
                AND signal_date >= #{signalDate}
                AND signal_date < DATE_ADD(#{signalDate}, INTERVAL 1 DAY)
            ]]>
        </if>


        ORDER BY signal_date DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>




    <!-- =====================================================
         pagination count
         ===================================================== -->
    <select id="countStrategyResults" resultType="int">
        SELECT COUNT(*)
        FROM strategy_result
        WHERE 1 = 1

        <if test="strategies != null and strategies.size() > 0">
            AND strategy_name IN
            <foreach collection="strategies"
                     item="s"
                     open="("
                     separator=","
                     close=")">
                #{s}
            </foreach>
        </if>

        <if test="strategy != null and strategy != ''">
            AND strategy_name = #{strategy}
        </if>

        <if test="signalDate != null">
            <![CDATA[
                AND signal_date >= #{signalDate}
                AND signal_date < DATE_ADD(#{signalDate}, INTERVAL 1 DAY)
            ]]>
        </if>

    </select>


</mapper>
